# API для сервиса аугментации изображений

## Описание проекта

Проект представляет собой API для сервиса аугментации изображений, реализованное с использованием FastAPI. Пользователь может зарегистрироваться и авторизоваться в системе, а затем отправлять изображения для получения соответствующих трансформированных копий. Поддерживаются следующие преобразования изображений:

- Поворот на 90 градусов
- Преобразование из RGB в Space Gray
- Изменение размера изображения в 2 раза с сохранением пропорций

Преобразованные и оригинальные изображения сохраняются в S3 хранилище (MinIO). Данные по каждому изображению сохраняются в таблице `ImageTask` в базе данных PostgreSQL, а миграции выполняются с помощью Alembic.

### Python 3.12

### Стек технологий

- FastAPI — фреймворк для создания API.
- PostgreSQL — база данных для хранения информации о пользователях и задачах.
- Alembic — миграции базы данных.
- SQLAlchemy — ORM для работы с базой данных.
- Celery — обработка фоновых задач (например, преобразование изображений).
- Redis — брокер сообщений для Celery.
- Minio — S3-совместимое хранилище для хранения изображений.
- Pytest — тестирование.
- Grafana — мониторинг и визуализация данных.
- Poetry — инструмент для управления зависимостями и пакетами.

## API Методы

| Метод | Путь                | Описание                                              |
|-------|--------------------|-------------------------------------------------------|
| POST  | /login             | Авторизация пользователя (возвращает JWT-токен)      |
| POST  | /registration      | Регистрация пользователя по email и password          |
| POST  | /upload            | Отправить список изображений                          |
| GET   | /status/{id}      | Получить статус выполнения задачи по данному id       |
| GET   | /history/{user_id} | Получить историю обработанных изображений для пользователя |
| GET   | /task/{id}        | Скачать изображения по данной задаче id в виде zip-архива |

## Инструкция по установке и запуску

### Шаги для запуска приложения

1. Склонируйте репозиторий:
   ```bash
   git clone <ссылка на ваш репозиторий>
   cd <директория проекта>
   ```

2. Создайте файл .env на основе .env.example и заполните его необходимыми значениями.

3. Установите Poetry, если он не установлен:
   ```bash
   curl -sSL https://install.python-poetry.org | python3 -
   ```

4. Установите зависимости проекта с помощью Poetry:
   ```bash
   poetry install
   ```

5. Запустите приложение с помощью Docker Compose:
   ```bash
   docker-compose up --build
   ```

6. Примените миграции для базы данных:
   ```bash
   poetry run alembic upgrade head
   ```

7. После успешного запуска, API будет доступен по адресу http://localhost:8000.

8. Для доступа к Grafana, перейдите по адресу http://localhost:3000 и используйте логин admin и пароль admin.

### Запуск тестов:
   ```bash
   poetry run pytest
   ```

### Установка pre-commit

Для автоматизации проверки кода перед коммитом вы можете использовать 
инструмент **pre-commit**. Вот как его установить и настроить:

### Установка

1. Установите pre-commit с помощью poetry:
   ```bash
   poetry run pre-commit install
   ```

2. Установите pre-commit hooks:
   ```bash
   pre-commit install
   ```

### Использование

Теперь при каждом коммите pre-commit будет автоматически проверять код на 
наличие проблем и исправлять их (например, удалять лишние пробелы и 
приводить код в соответствии с PEP 8). Если будут найдены ошибки, 
коммит будет остановлен до их исправления.

### Запуск вручную

Вы можете также запустить pre-commit вручную на всех файлах в проекте:
```bash
poetry run pre-commit run --all-files
```

### Запуск тестов

Для запуска тестов используйте pytest
```bash
docker-compose exec web pytest
```

### Примечания
- Celery использует брокер Redis с настройкой через Prefork.
